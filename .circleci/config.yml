version: 2
jobs:
  build:
    docker:
      - image: circleci/node:latest
    steps:
      - checkout
      - restore_cache:
          keys:
            - dependency-cache-{{ checksum "yarn.lock" }}
            - dependency-cache-
      - run:
          name: Install dependencies
          command: yarn
      - save_cache:
          key: dependency-cache-{{ checksum "yarn.lock" }}
          paths:
            - node_modules
      - run:
          name: Compile
          command: yarn compile
      - run:
          name: Dependency check
          command: yarn check-dependencies
      - run:
          name: Lint
          command: yarn lint
      - run:
          name: Save environment for later reuse
          command: echo "export COVERALLS_SERVICE_JOB_ID=$CIRCLE_BUILD_NUM" > .saved_env
      - persist_to_workspace:
          root: '.'
          paths:
            - src
            - test
            - yarn.lock
            - .saved_env
  test:
    parallelism: 3
    docker:
      - image: circleci/node:latest
    steps:
      - checkout
      - attach_workspace:
          at: '.'
      - restore_cache:
          key: dependency-cache-{{ checksum "yarn.lock" }}
      - run:
          name: Install correct version of TypeScript for testing
          command: |
            case $CIRCLE_NODE_INDEX in
              0)
                yarn add typescript@2.4;;
              2)
                yarn add typescript@next;;
            esac

      - run:
          name: Test with Coverage
          command: yarn coverage
      - run:
          name: Restore environment
          command: cat .saved_env >> $BASH_ENV
      - run:
          name: Report code coverage
          command: 'yarn report-coverage'
          environment:
            COVERALLS_PARALLEL: true
      - deploy:
          command: |
            curl -k https://coveralls.io/webhook?repo_token=$COVERALLS_REPO_TOKEN -d "payload[build_num]=$COVERALLS_SERVICE_JOB_ID&payload[status]=done"

workflows:
  version: 2
  verify:
    jobs:
      - build
      - test:
          requires:
            - build
